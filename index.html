<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="hust.jpg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hust timetable to Google Calendar</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    input, button { padding: 10px; margin: 10px; }
    #download_link { display: none; }
    #message { color: green; font-weight: bold; display: none; }
    #debug { 
      background: #f9f9f9; 
      border: 1px solid #ccc; 
      padding: 10px; 
      margin: 10px; 
      font-size: 0.9em; 
      display: none;
      max-height: 280px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h1>Hust timetable to Google Calendar</h1>
  <div>Hướng dẫn sử dụng: Ở dòng đầu tiên, mọi người hãy nhập ngày đầu tiên của năm học và nó luôn là thứ hai. Nhớ là ngày đầu tiên của năm học chứ không phải thứ hai đầu tiên các bạn đến trường, ví dụ tuần đầu tiên các bạn không có tiết hôm thứ hai và điền thứ hai của tuần sau là sai. Trong kỳ 20242 này thì ngày này sẽ là 10/02/2025. Ở phần file excel, các bạn xếp lịch học trên web của anh hieupham2k1 rồi tải file excel xuống và up thẳng lên đây rồi bấm generate. Sau khi tải được file CSV xuống thì mọi người làm theo video hướng dẫn trên ytb để import csv lên Google Calendar.</div>
  <label for="first_monday">Enter the first Monday of the semester (dd/mm/yyyy):</label>
  <input type="text" id="first_monday" placeholder="dd/mm/yyyy">
  
  <br><br>
  
  <label for="file_input">
    Upload Excel file from 
    <a href="https://hieupham2k1.web.app/time-table" target="_blank">Hieupham2k1 | Timetable</a>:
  </label>
  <input type="file" id="file_input" accept=".xlsx, .xls">
  
  <br><br>
  <img src="excel.jpg" alt="Description of the image" height="300">
  <br><br>

  <button onclick="generateSchedule()">Generate Schedule</button>
  
  <br><br>
  
  <div id="message">Your class schedule CSV is ready! Click the link below to download it.</div>
  <a id="download_link" href="#" download="class_schedule_events.csv">Download CSV</a>
  
  <div id="debug"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
  <script>
    function debugMessage(msg) {
      const debugDiv = document.getElementById("debug");
      debugDiv.style.display = "block";
      const p = document.createElement("p");
      p.textContent = msg;
      debugDiv.appendChild(p);
      console.log(msg);
    }

    // --- Helpers ---
    function parseLocalDMY(dmy) {
      const [d, m, y] = String(dmy).split('/').map(Number);
      if (!d || !m || !y) return null;
      return new Date(y, m - 1, d); // local time (no UTC surprises)
    }

    // Extract all integer week numbers from a cell like "24-30, 32, 35-36"
    function extractWeekNumbers(weeksStr) {
      const out = [];
      String(weeksStr).split(',').forEach(part => {
        const s = part.trim();
        if (!s) return;
        if (s.includes('-')) {
          const [a, b] = s.split('-').map(n => parseInt(n.trim(), 10));
          if (!isNaN(a) && !isNaN(b) && b >= a) {
            for (let k = a; k <= b; k++) out.push(k);
          }
        } else {
          const v = parseInt(s, 10);
          if (!isNaN(v)) out.push(v);
        }
      });
      return out;
    }

    // Map various encodings to Monday=0..Sunday=6
    function toWeekdayNum(dayVal) {
      const num = Number(dayVal);
      if (!isNaN(num)) {
        // Common encodings:
        // Excel code 2..8 => Mon..Sun
        if (num >= 2 && num <= 8) return num - 2; // 2->0 ... 8->6
        // Or 1..7 => Mon..Sun
        if (num >= 1 && num <= 7) return num - 1; // 1->0 ... 7->6
      }
      // Text encodings (English / Vietnamese)
      const s = String(dayVal).toLowerCase().trim();
      if (s.startsWith('mon') || s.includes('thứ 2') || s.includes('thu 2') || s === 'hai') return 0;
      if (s.startsWith('tue') || s.includes('thứ 3') || s.includes('thu 3') || s === 'ba') return 1;
      if (s.startsWith('wed') || s.includes('thứ 4') || s.includes('thu 4') || s === 'tư') return 2;
      if (s.startsWith('thu') || s.includes('thứ 5') || s.includes('thu 5') || s === 'năm') return 3;
      if (s.startsWith('fri') || s.includes('thứ 6') || s.includes('thu 6') || s === 'sáu') return 4;
      if (s.startsWith('sat') || s.includes('thứ 7') || s.includes('thu 7') || s === 'bảy') return 5;
      if (s.startsWith('sun') || s.includes('cn') || s.includes('chủ nhật')) return 6;

      return undefined; // unknown
    }

    function formatTime(raw) {
      const digits = String(raw).replace(/\D/g, ''); // keep only 0-9
      if (!digits) return null;
      const hhmm = digits.padStart(4, '0').slice(-4); // e.g., "800" -> "0800"
      const hh = hhmm.slice(0, 2);
      const mm = hhmm.slice(2, 4);
      return `${hh}:${mm}`;
    }

    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function convertToCSV(data) {
      if (data.length === 0) return "";
      const headers = Object.keys(data[0]);
      const rows = data.map(row =>
        headers.map(fieldName =>
          JSON.stringify(row[fieldName], (k, v) => (v === null || v === undefined) ? '' : v)
        ).join(',')
      );
      // add BOM so Excel/Google handles UTF-8 consistently
      return '\uFEFF' + [headers.join(','), ...rows].join('\r\n');
    }

    // --- Core ---
    function generateSchedule() {
      const firstMondayStr = document.getElementById("first_monday").value;
      const fileInput = document.getElementById("file_input");

      if (!firstMondayStr || !fileInput.files.length) {
        alert("Please provide the first Monday date and upload a file.");
        return;
      }

      const firstMonday = parseLocalDMY(firstMondayStr);
      if (!firstMonday || isNaN(firstMonday.getTime())) {
        alert("Invalid date. Please use format dd/mm/yyyy.");
        return;
      }

      debugMessage("Starting schedule generation...");
      debugMessage("Parsed first Monday date (local): " + firstMonday.toDateString());

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        debugMessage("File loaded successfully.");
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'array', raw: true });

        let allRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        debugMessage("Excel sheet parsed. Total rows (including header): " + allRows.length);

        // Remove the header row
        let dataRows = allRows.slice(1);
        debugMessage("Header row removed. Data rows count: " + dataRows.length);

        // Remove the first data row (if your old pipeline expected that)
        dataRows = dataRows.slice(1);
        debugMessage("First data row removed. Remaining rows count: " + dataRows.length);

        // --- Detect baseWeek automatically from column 15 (index 15) ---
        let baseWeek = Infinity;
        for (const row of dataRows) {
          if (!row || row.length < 16) continue;
          const weekCell = row[15];
          const weeks = extractWeekNumbers(weekCell);
          for (const w of weeks) if (Number.isInteger(w)) baseWeek = Math.min(baseWeek, w);
        }
        if (!isFinite(baseWeek)) {
          alert("Could not detect the base week from the Excel file. Please check column 15 (weeks).");
          return;
        }
        debugMessage("Detected base week = " + baseWeek + " (auto-anchored to first Monday).");

        const eventData = [];

        for (let i = 0; i < dataRows.length; i++) {
          const row = dataRows[i];
          if (!row || row.length < 17) {
            debugMessage("Skipping row " + (i + 2) + " due to insufficient columns.");
            continue;
          }

          const subject = row[6];        // Column 7 in human terms (index 6)
          const week = row[15];          // Column 16 (index 15)
          const dayOfWeek = row[10];     // Column 11 (index 10)
          let timeRangeStr = row[11];    // Column 12 (index 11), e.g. "0800-0930" or "08:00-09:30"
          const location = row[16];      // Column 17 (index 16)

          if (timeRangeStr == null) {
            debugMessage("Missing time range in row " + (i + 2) + ". Skipping row.");
            continue;
          }

          // Normalize time range
          let startTime = null, endTime = null;
          if (typeof timeRangeStr === "string" && timeRangeStr.includes("-")) {
            const parts = timeRangeStr.split("-");
            startTime = formatTime(parts[0]);
            endTime = formatTime(parts[1]);
          } else {
            // Sometimes Excel might store times as numbers or without '-'
            const str = String(timeRangeStr);
            if (str.includes("-")) {
              const parts = str.split("-");
              startTime = formatTime(parts[0]);
              endTime = formatTime(parts[1]);
            }
          }
          if (!startTime || !endTime) {
            debugMessage("Invalid time range format in row " + (i + 2) + ". Skipping row.");
            continue;
          }

          const weekdayNum = toWeekdayNum(dayOfWeek);
          if (weekdayNum === undefined) {
            debugMessage("Unrecognized dayOfWeek code in row " + (i + 2) + ": " + dayOfWeek);
            continue;
          }

          debugMessage(`Processing row ${i + 2}: Subject=${subject}, Weeks=${week}, DayCode=${dayOfWeek}→${weekdayNum}`);

          const classDates = calculateClassDates(week, weekdayNum, firstMonday, baseWeek);
          classDates.forEach(classDate => {
            const startDate = formatDate(classDate);
            eventData.push({
              Subject: subject || "",
              StartDate: startDate,
              EndDate: startDate,
              "Start Time": startTime,
              "End Time": endTime,
              "All Day Event": false,
              Location: location || "",
              Private: false
            });
          });
        }

        if (eventData.length === 0) {
          alert("No events generated. Please re-check the file format and inputs.");
          return;
        }

        const csv = convertToCSV(eventData);
        const downloadLink = document.getElementById("download_link");
        const message = document.getElementById("message");

        // data URI
        downloadLink.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
        downloadLink.style.display = "block";
        message.style.display = "block";
        debugMessage("CSV generated successfully. Download link is now visible.");
      };

      reader.readAsArrayBuffer(file);
    }

    // Compute class dates from a week spec (e.g., "24-26,28") and a weekday number (Mon=0..Sun=6)
    function calculateClassDates(weeksStr, weekdayNum, firstMonday, baseWeek) {
      const dates = [];
      const parts = String(weeksStr).split(',').map(s => s.trim()).filter(Boolean);

      parts.forEach(part => {
        if (part.includes('-')) {
          let [a, b] = part.split('-').map(Number);
          if (!isNaN(a) && !isNaN(b) && b >= a) {
            for (let w = a; w <= b; w++) {
              addOneWeek(w, weekdayNum, firstMonday, baseWeek, dates);
            }
          }
        } else {
          const w = Number(part);
          if (!isNaN(w)) addOneWeek(w, weekdayNum, firstMonday, baseWeek, dates);
        }
      });

      debugMessage("Calculated " + dates.length + " class date(s) for weeks: " + weeksStr);
      return dates;
    }

    function addOneWeek(weekNum, weekdayNum, firstMonday, baseWeek, outDates) {
      // Anchor weekNum to the detected baseWeek
      const startOfWeek = new Date(firstMonday.getTime() + (weekNum - baseWeek) * 7 * 24 * 60 * 60 * 1000);

      // JS: Sunday=0..Saturday=6 → convert to Monday=0..Sunday=6
      const startWeekday = (startOfWeek.getDay() + 6) % 7;
      const daysDiff = (weekdayNum - startWeekday + 7) % 7;

      const classDate = new Date(startOfWeek.getTime() + daysDiff * 24 * 60 * 60 * 1000);
      outDates.push(classDate);
    }
  </script>

  <iframe width="560" height="315" src="https://www.youtube.com/embed/XltwQzzLIP8?si=qnVgiCFBjO69FlLt" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</body>
</html>

